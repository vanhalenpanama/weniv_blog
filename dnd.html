<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 모험 with ChatGPT</title>
</head>
<style>
body {
    font-family: 'MedievalSharp', cursive;
    background-size: contain;
    background-attachment: fixed;
    color: #f0e6d2;
    margin: 0;
    padding: 0;
}

#app {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
}

h1 {
    text-align: center;
    font-size: 2.5em;
    color: #ffd700;
    text-shadow: 2px 2px 4px #000000;
}

#chat-container {
    height: 630px;
    overflow-y: auto;
    border: 2px solid #8b4513;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 20px;
    background-color: rgba(0, 0, 0, 0.5);
}

#chat-messages {
    display: flex;
    flex-direction: column;
}

.message {
    max-width: 80%;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.user-message {
    background-color: #4b3621;
    align-self: flex-end;
    text-align: left;
    justify-content: flex-end; /* 메시지를 오른쪽에 배치 */	
}

.assistant-message {
    background-color: #2f4f4f;
    align-self: flex-start;
    text-align: left;
}

#input-container {
    display: flex;
}

#user-input {
    flex-grow: 1;
    resize: none;
    padding: 10px;
    border: 2px solid #8b4513;
    border-radius: 5px 0 0 5px;
    background-color: #2c2c2c;
    color: #f0e6d2;
    font-size: 16px;
    width: calc(100% - 80px); /* 버튼의 크기를 고려한 넓이 조정 */
    min-height: 40px;
    max-height: 150px; /* 필요에 따라 조정 가능 */
    overflow-y: auto;
}

button {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #8b4513;
    color: #f0e6d2;
    border: none;
    border-radius: 0 5px 5px 0;
    cursor: pointer;
    transition: background-color 0.3s;
}

button:hover {
    background-color: #a0522d;
}

footer {
    text-align: center;
    margin-top: 20px;
    font-size: 0.8em;
    color: #a0a0a0;
}

#send-btn {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #8b4513;
    color: #f0e6d2;
    border: none;
    border-radius: 0 5px 5px 0;
    cursor: pointer;
    transition: background-color 0.3s;
}

#send-btn:hover {
    background-color: #a0522d;
}

#download-txt {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #8b4513;
    color: #f0e6d2;
    border: none;
    border-radius: 0 5px 5px 0;
    cursor: pointer;
    transition: background-color 0.3s;
}

#download-html {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #8b4513;
    color: #f0e6d2;
    border: none;
    border-radius: 0 5px 5px 0;
    cursor: pointer;
    transition: background-color 0.3s;
}

#download-html:hover {
    background-color: #a0522d;
}

#download-csv:hover {
    background-color: #a0522d;
}

#download-txt:hover {
    background-color: #a0522d;
}

#download-csv {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #8b4513;
    color: #f0e6d2;
    border: none;
    border-radius: 0 5px 5px 0;
    cursor: pointer;
    transition: background-color 0.3s;
}

</style>
<body>
    <div id="app">
        <h1>D&D 모험 with ChatGPT</h1>
        <div id="chat-container">
            <div id="chat-messages"></div>
        </div>
        <div id="input-container">
                <textarea id="user-input" rows="1" placeholder="당신의 행동을 입력하세요..."></textarea>
            <button id="send-btn">전송</button>
        <!-- <button id="download-txt">TXT 저장</button>
        <button id="download-csv">CSV 저장</button> -->
        <button id="download-html">HTML 저장</button>
        </div>
    </div>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const chatContainer = document.getElementById('chat-messages');
    const chatScroll = document.getElementById('chat-container');	
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const downloadTxtBtn = document.getElementById('download-txt');
    const downloadCsvBtn = document.getElementById('download-csv');
    const downloadHtmlBtn = document.getElementById('download-html');

    let conversation = [
        {
            role: "system", 
            content: "당신은 D&D 게임의 던전 마스터(DM)입니다. 플레이어들을 판타지 세계의 모험으로 안내하고, 그들의 선택에 따라 이야기를 진행하세요. D&D의 규칙을 따르되, 재미있고 흥미진진한 모험을 만들어주세요."
        }
    ];

    function addMessage(role, content) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${role}-message`;
        const messageContent = document.createElement('div');
        messageContent.innerHTML = content;
        messageElement.appendChild(messageContent);
        chatContainer.appendChild(messageElement);
        chatScroll.scrollTop = chatScroll.scrollHeight;
    }

    async function sendMessage() {
        const message = userInput.value.trim();
        if (message) {
            addMessage('user', message);
            userInput.value = '';
	    userInput.style.height = 'auto'; // textarea 크기 초기화

            conversation.push({ role: "user", content: message });

            try {
                const response = await fetch('https://open-api.jejucodingcamp.workers.dev/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(conversation)
                });

                if (response.ok) {
                    const data = await response.json();
                    const gptResponse = data.choices[0].message.content;
                    addMessage('assistant', gptResponse);
                    conversation.push({ role: "assistant", content: gptResponse });
                } else {
                    throw new Error('API 요청 실패');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('system', '오류가 발생했습니다. 다시 시도해주세요.');
            }
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // 초기 메시지
    addMessage('assistant', '환영합니다, 모험가님! 판타지 세계에서의 모험은 당신의 손에 달려 있습니다. 아래의 항목들을 참고하여 나만의 캐릭터를 설정해 보세요! (예시: **캐릭터 이름**: 롤란드  **종족**: 인간  **직업**: 전사)');



    // 배경 이미지 변경
    let availableImages = Array.from({ length: 10 }, (_, i) => i);
    let usedImages = [];

    function changeBackgroundImage() {
        if (availableImages.length === 0) {
            availableImages = usedImages;
            usedImages = [];
        }
        const randomIndex = Math.floor(Math.random() * availableImages.length);
        const imageNumber = availableImages.splice(randomIndex, 1)[0];
        usedImages.push(imageNumber);
        document.body.style.backgroundImage = `url('img/th${imageNumber}.jpg')`;
    }

    // 페이지가 로드될 때 배경 이미지 변경
    changeBackgroundImage();
    
    // 현재 날짜와 시간을 기반으로 파일명 생성
    function getFormattedFilename(extension) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `conversation${year}_${month}_${date}_${hours}_${minutes}.${extension}`;
    }    

    // TXT 파일 저장 기능
    function downloadTxt() {
        const text = conversation.map(item => `[${item.role}]: ${item.content}`).join('\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = getFormattedFilename('txt');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }   

    // CSV 파일 저장 기능
    function downloadCsv() {
        const rows = conversation.map(item => `${item.role}, "${item.content.replace(/"/g, '""')}"`);
        const csvContent = '\uFEFF' + rows.join('\n');  // UTF-8 BOM 추가
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = getFormattedFilename('csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

   // HTML 파일 저장 기능
   function downloadHtml() {
    const chatMessages = document.getElementById('chat-messages').innerHTML;
    const styles = `
        <style>
        body {
            font-family: 'MedievalSharp', cursive;
            background-image: url('th3.jpg');
            background-size: contain;
            background-attachment: fixed;
            color: #f0e6d2;
            margin: 0;
            padding: 0;
        }
        
        #app {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            text-align: center;
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 2px 2px 4px #000000;
        }
        
        #chat-container {
            max-width: 1000px;
            height: auto;
            overflow-y: auto;
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        #chat-messages {
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #4b3621;
            align-self: flex-end;
            text-align: left;
            justify-content: flex-end; /* 메시지를 오른쪽에 배치 */	
        }
        
        .assistant-message {
            background-color: #2f4f4f;
            align-self: flex-start;
            text-align: left;
        }
        
        #input-container {
            display: flex;
        }
        
        #user-input {
            flex-grow: 1;
            resize: none;
            padding: 10px;
            border: 2px solid #8b4513;
            border-radius: 5px 0 0 5px;
            background-color: #2c2c2c;
            color: #f0e6d2;
            font-size: 16px;
            width: calc(100% - 80px); /* 버튼의 크기를 고려한 넓이 조정 */
            min-height: 40px;
            max-height: 150px; /* 필요에 따라 조정 가능 */
            overflow-y: auto;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #8b4513;
            color: #f0e6d2;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #a0522d;
        }
        
        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8em;
            color: #a0a0a0;
        }
        
        #send-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #8b4513;
            color: #f0e6d2;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #send-btn:hover {
            background-color: #a0522d;
        }
        
        #download-txt {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #8b4513;
            color: #f0e6d2;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #download-html {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #8b4513;
            color: #f0e6d2;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #download-csv {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #8b4513;
            color: #f0e6d2;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }        
        </style>
    `;
    const htmlContent = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Chat History</title>
            ${styles}
        </head>
        <body>
        <div id="chat-container">
            <div id="chat-messages">
                ${chatMessages}
            </div>
            </div>
        </body>
        </html>
    `;
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = getFormattedFilename('html');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}



    downloadTxtBtn.addEventListener('click', downloadTxt);
    downloadCsvBtn.addEventListener('click', downloadCsv);
    downloadHtmlBtn.addEventListener('click', downloadHtml);


});

    </script>
</body>
</html>
